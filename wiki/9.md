## 9. 익스프레스로 SNS 서비스 만들기
- 이 장에서 지금까지 배운 내용들로 실제 웹 서비스를 제작한다. Express 구조를 익히기 위해 모든 내용은 수동으로 한다.
---

#### 1. 프로젝트 구조 갖추기
- 제일먼저 프로젝트 폴더를 생성 후, package.json을 생성한다.
```json
{
  "name": "nodebird",
  "version": "0.0.1",
  "description": "익스프레스로 만드는 SNS 서비스",
  "main": "app.js",
  "scripts": {
    "start": "nodemon app"
  },
  "author": "Kioni",
  "license": "MIT"
}
```
- Sequelize, MySQL
```bash
npm i -g sequelize-cli
npm i sequelize mysql2 # node_modules, package-lock.json 생성
sequelize init # config, migrations, models, seeders 생성
```
- views, routes, public 폴더 생성
```bash
mkdir views routes public
```
- 필요한 npm 패키지 설치
```bash
npm i express cookie-parser express-session morgan connect-flash pug
npm i -g nodemon
npm i -D nodemon
```
- app.js 생성하여 작성하기 [ => app.js]()
- cookieParser와 express-session의 비밀키를 위한 dotenv패키지 사용.
```bash
# 비밀키는 .env 라는 파일에 모아두고 dotenv가 .env 파일을 읽어 process.env 객체에 넣는다.
npm i dotenv
```
```javascript
// 실제 사용은 require 와 함께, secret: process.env.COOKIE_SECRET를 설정한다.
require('dotenv').config();
app.use(cookieParser(process.env.COOKIE_SECRET));
secret: process.env.COOKIE_SECRET, // app.use(session 내부
```
- 라우터와 템플릿 엔진 파일 생성  
[routes/page.js]()  
[views/layout.pug](), 
[main.pug](), 
[profile.pug](), 
[join.puh](), 
[error.pug]()  
[public/main.css]()  

#### 2. 데이터 베이스 셋팅하기
- sequelize 모델 만들기  
[models/user.js](),
[models/post.js](),
[models/hashtag.js]()  
[models/index.js]()

- 데이터베이스 Connection 설정  
[config/config.json]()

- 데이터 베이스 생성
```bash
# 실행후 schema 가 생성되는 것을 확인할 수 있다.
sequelize db:create
```

- 데이터 베이스 모델과 연결하기 (app.js)
```javascript
const { sequelize } = require('./models');
sequelize.sync();
```

#### 3. Passport 모듈로 로그인 구현하기
- Passport 관련 패키지 설치
```bash
npm i passport passport-local passport-kakao bcrypt
```
- app.js에 모듈 추가
```javascript
const passport = require('passport');
const passportConfig = require('./passport');
passportConfig(passport);
app.use(passport.initialize());
app.use(passport.session());
```
- [passport/index.js]() 작성하기  
serializeUser는 사용자 정보 객체를 세션에 아이디로 저장한다.  
deserializeUser는 세션에 저장한 아이디를 통해 사용자 정보 객체를 불러오는 것이다.

- 로컬 로그인 구현하기  
로그인을 한 유저는 회원가입과 로그인화면이 보이지 않아야 하고,  
로그인 하지 않은 유저는 로그아웃이 보이면 안된다. 이런 과정을 passport의 isAuthenticated 메서드로 구현이 가능하다.  
[routes/middlewares.js]() 미들웨어 구현하기.  
[routes/page.js]() 에 만들어진 미들웨어 사용하기.
```javascript
const { isLoggedIn, isNotLoggedIn } = require('./middlewares');

router.get('/profile', isLoggedIn, (req, res) => {
    res.render('profile', { title: '내 정보 - NodeBird', user: req.user });
});

router.get('/join', isNotLoggedIn, (req, res) => {...

user: req.user,
```
- 회원가입, 로그인, 로그아웃 구현하기 [ => routes/auth.js]()
- 로컬 로그인 전략 구현하기 [ => passport/localStrategy.js]()